---
title: "TRY"
author: "Zhikuan Quan"
output: html_document
---

# Background
Research shows the tax on alcohol consumption, minimum drinking age, punishment, personal income, and unemployment rate are associated with drunk driving fatalities.

```{r}
# Input Data
library(AER)
library(plm)
library(stargazer)
library(tidyverse)
data("Fatalities")
# Missing Values
# since 1982-1988 is no, we assume it is "no" in missing place(Need some paper/law to ensure)
tna<-which(is.na(Fatalities),arr.ind= TRUE) # CA 1988 missing: jail, service
Fatalities[28,15]<-"no" 


```

# Exploratory Data Analysis
## Data exploration
This study used a balanced panel data for the 48 states in United States (excluding Alaska, Hawaii, and the District of Columbia) from 1982 to 1988, with 336 observations in total. The vehicl fatality rate per year of each state was calculated by dividing the number of vehicle fatalities by state population, then multiplying by 10000 to represent the average fatality every 10000 people. As shown in Figure 1, the average fatality rates over 7 years are quite different across the country. Rhode Island has the lowest fatality rate (1.11) while New Mexico has the highest (3.65).  
```{r, echo=FALSE, include=FALSE}
library(AER)
data("Fatalities")
dat = Fatalities
dat$y = dat$fatal/dat$pop * 10000
dat00 = aggregate(y~state, data = dat, mean)
fatal_state = data.frame(fatality = dat00$y, state = unique(dat$state)) 
library(usmap)
library(ggplot2)
p1 = plot_usmap(regions = 'state', data = fatal_state, values = "fatality",
     exclude = c('AK', 'HI'))+ scale_fill_continuous(high = "#132B43", low = "#56B1F7", 
                name = "Average fatality") + theme(legend.position = "right")
```

```{r, echo=FALSE}
p1
```

__Figure 1 Average fatality rates over 1982 through 1988 across United States__

Unemployment rate (unemp), spirits consumption (spirits), per capita income (income), tax on beer (beertax) and mandatory jail sentence for the first DUI conviction (jail) were shown as important factors affecting the vehicle fatality rate (Ruhm, 1996), so they were also considered in this study. As shown in Figure 2, the average per capita income across the country kept increasing from 1982 to 1988, while spirits consumption,unemployment rate and tax on beer decreased. Average fatality stayed rather stable over 7 years, and states having mandatory jail sentence seems to have higher average fatality than those not (Figure 3), which is surprising and will be analyzed in the following. There was one missing value of mandatory jail sentence status for California in 1988, which was replaced with "no" after searching the online information and double-checking with the local government. Per capita income was removed from the statistic model to avoid collinearity because it has a high correlation (-0.55) with unemployment rate, and is more correlated to other variables than unemployment rate (Figure 4).

```{r, echo=FALSE}
par(mfrow = c(2,2))
dat01 = aggregate(income~year,data = dat, mean)
plot(1982:1988, dat01$income, type = 'b', xlab = 'Year',
     ylab = 'Per capita income, $', main = 'Income')
dat02 = aggregate(spirits~year,data = dat, mean)
plot(1982:1988, dat02$spirits, type = 'b', xlab = 'Year',
     ylab = 'Per capita spirits consumption, gal', main = 'Spirits consumption')
dat03 = aggregate(unemp~year,data = dat, mean)
plot(1982:1988, dat03$unemp, type = 'b', xlab = 'Year',
     ylab = 'Unemployment rate, %', main = 'Unemployment rate')
dat04 = aggregate(beertax~year,data = dat, mean)
plot(1982:1988, dat04$beertax, type = 'b', xlab = 'Year',
     ylab = 'Tax on case of beer, $', main = 'Beer tax')
```

__Figure 2 The trends of income, spirits comsumption, unemployment rate and tax on beer from 1982 to 1988__

```{r, echo=FALSE}
ggplot(dat, aes(x = year, y = y, fill = jail)) + geom_boxplot() + labs(y = "Average fatality")
```

__Figure 3 The effect of mandatory jail sentence on average fatality from 1982 to 1988__

```{r, echo=FALSE}
dat1 = dat[lapply(dat, typeof)== 'double']
plot(dat1[,c(1,2,3,5)])
```

__Figure 4 Pairwise correlation among income, spirits comsumption, unemployment rate and tax on beer__

```{r}
# DATA of interest
DATA<-Fatalities %>%
  #filter(complete.cases(.)) %>%
  transmute(fr = 10000*((fatal/pop)), jail = as.factor(jail),state = as.factor(state), year = as.factor(year),beertax = beertax,emppop = emppop,miles = miles,income = income,drinkage = as.factor(floor(drinkage)), unemp=unemp, spirits = spirits,service = as.factor(service),breath=as.factor(breath),afatal=10000*(afatal/pop))
# summary statistics for data: balanced
summary(DATA) # no extreme values
attach(DATA)
tjs<-table(state,jail) # jail of CT, NV, OH, OR, SC, UT changes over time
detach(DATA)

DATA1<-DATA %>%
  filter(state == "ct"|state =="nv"|state =="oh"|state =="or"|state =="sc"|state =="ut")

# 
ggplot(DATA, aes(x = year, y = afatal, group = jail, col = jail)) + 
  geom_point() + stat_summary(fun.y = mean, geom = "line")
```

# Modeling
We set the model notations as below:

- Response variable $Y_{it}$: the traffic fatality rate of state $i$ in time $t$;

- Time fixed effect $\alpha_t$: time specific intercept(a vector of dummy variables). It represents any change over time (1982-1988) that affects all observational units in the same way;

- Mandatory jail sentence indicator $X_{it}$: $X_{it}=1$ when there is mandatory jail sentence of state $i$ in time $t$; $X_{it}=0$ when there is no mandatory jail sentence of state $i$ in time $t$;  

- Covariates vector $Z_{it}$: potential time-varying covariates. In this case, we mainly focus on XXXX.

- State fixed effect $S_i$: In this case, each level of $S_i$ represents one of 48 states in US excluding Alaska and Hawaii.

The fixed effect model equation is:
$$Y_{it}=\alpha_t+\beta X_{it}+\gamma Z_{it}+S_i+\epsilon_{it}$$
where $\epsilon_{it}$ is error term. In fixed effect model, we assume that:

1. The normality of error terms:

2. The homogeneity of variance assumption:

3. Independent assumption: in time series data, the error terms are allowed to be autocorrelated within states, which means that there is autocorrelation relationship across time in one specific state. However, in a fixed time, the 



```{r}

#cor(DATA[,c(1,5,6,7,8,10,11)])
# Model 1
fit1 <- plm(fr ~ jail+unemp+beertax+income+spirits, data = DATA, index = c("state","year"),model = "within", effect = "twoways")
summary(fit1)

# Model 1
fit1 <- plm(fr ~ jail+unemp+income+spirits, data = DATA, index = c("state","year"),model = "within", effect = "twoways")
summary(fit1)

# Model: Non-normality
fit1 <- plm(afatal ~ jail+beertax+spirits, data = DATA, index = c("state","year"),model = "within", effect = "twoways")
summary(fit1)

```

```{r}
## Model Diagnositics
sr<-scale(residuals(fit1))
preds<-predict(fit1)
# Normality
qqnorm(sr, ylab = 'Standard Residuals')
qqline(sr)

shapiro.test(as.vector(sr))


hist(residuals(fit1), xlab = 'Residuals')

# test for time effect and state effect
plmtest(fit1, c("time"), type=("bp"))
plmtest(fit1, c("individual"), type=("bp"))
plmtest(fit1, c("twoways"), type=("bp"))


pbgtest(fit1)



## Constant Variance
plot(as.vector(residuals(fit1)))
bptest(fit1)


```
